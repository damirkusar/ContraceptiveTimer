package ch.kusar.contraceptivetimer.wrapper;

import java.util.Calendar;
import java.util.GregorianCalendar;

import android.app.AlarmManager;
import android.app.PendingIntent;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.widget.Toast;
import ch.kusar.contraceptivetimer.MainActivity;
import ch.kusar.contraceptivetimer.MainApplicationContext;
import ch.kusar.contraceptivetimer.businessobjects.AlarmEventData;
import ch.kusar.contraceptivetimer.retriever.AlarmEventRetriever;

public class AlarmManagerWrapper extends BroadcastReceiver {
	@Override
	public void onReceive(Context context, Intent intent) {

		// Put here YOUR code.
		LoggerWrapper.LogInfo("ContraceptiveTimer is now in onReceive Method of the AlarmManagerWrapper to handle the Event.");
	}

	public void SetAlarm() {
		LoggerWrapper.LogInfo("ContraceptiveTimer is now in setAlarm Method.");

		Context context = MainApplicationContext.getAppContext();

		AlarmEventRetriever alarmEventRetriever = new AlarmEventRetriever();
		AlarmEventData alarmEventData = alarmEventRetriever.retrieveAlarmEventData();

		LoggerWrapper.LogInfo("ContraceptiveTimer is now before If construct.");
		if (alarmEventData != null) {
			LoggerWrapper.LogInfo("ContraceptiveTimer is now trying to setup alarm from file..");
			Toast.makeText(context, "My Contraception: Trying to setup alarm from file.", Toast.LENGTH_LONG).show();

			AlarmManager am = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);

			Intent intent = new Intent(context, AlarmManagerWrapper.class);
			intent.putExtra(AlarmEventData.getIntentname(), alarmEventData);

			PendingIntent pi = PendingIntent.getBroadcast(context, 0, intent, 0);
			// am.set(AlarmManager.RTC_WAKEUP,
			// alarmEventData.getAlarmTimeInMilliSeconds(), pi);

			GregorianCalendar gregorianCalendar = (GregorianCalendar) Calendar.getInstance();
			gregorianCalendar.add(Calendar.SECOND, 10);
			am.set(AlarmManager.RTC_WAKEUP, gregorianCalendar.getTimeInMillis(), pi);
		} else {
			LoggerWrapper.LogInfo("ContraceptiveTimer is now starting the app because no file was detected.");
			Toast.makeText(context, "My Contraception: Nothing to setup an alarm. Please configure in App.", Toast.LENGTH_LONG).show();
			Intent intent = new Intent(context, MainActivity.class);
			context.startActivity(intent);
		}
		LoggerWrapper.LogInfo("ContraceptiveTimer is now finishing the setAlarm Method.");
	}

	public void CancelAlarm(Context context) {
		Intent intent = new Intent(context, AlarmManagerWrapper.class);
		PendingIntent sender = PendingIntent.getBroadcast(context, 0, intent, 0);
		AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);
		alarmManager.cancel(sender);
	}
}
