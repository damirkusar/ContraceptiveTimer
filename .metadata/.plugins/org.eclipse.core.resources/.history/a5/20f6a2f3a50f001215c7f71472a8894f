package ch.kusar.contraceptivetimer;

import android.app.Activity;
import android.os.Bundle;
import android.view.Menu;
import android.view.View;
import android.widget.TimePicker;
import android.widget.ToggleButton;
import ch.kusar.contraceptivetimer.businessobjects.ContraceptiveType;
import ch.kusar.contraceptivetimer.calculator.AlarmCalculationData;
import ch.kusar.contraceptivetimer.wrapper.AlarmManagerWrapper;
import ch.kusar.contraceptivetimer.wrapper.CalendarWrapper;
import ch.kusar.contraceptivetimer.wrapper.InternalStorageWrapper;
import ch.kusar.contraceptivetimer.wrapper.LoggerWrapper;

//import android.view.MenuItem;
//import android.support.v4.app.NavUtils;
public class MainActivity extends Activity {

	private InternalStorageWrapper internalStorageWrapper;
	private ContraceptiveType contraceptiveType;

	@Override
	public void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		this.setContentView(R.layout.activity_main);

		this.internalStorageWrapper = new InternalStorageWrapper(MainApplicationContext.getAppContext());

		// TODO Remove it when it goes live.
		AlarmManagerWrapper alarmManagerWrapper = new AlarmManagerWrapper();
		alarmManagerWrapper.SetAlarm();

		this.setupViews();

	}

	private void setupViews() {
		TimePicker tp = (TimePicker) this.findViewById(R.id.timePicker);
		tp.setIs24HourView(true);

		AlarmCalculationData acd = this.internalStorageWrapper.loadFromStorage();
		if (acd != null) {
			tp.clearFocus();
			tp.setCurrentHour(acd.getAlarmTimeHourOfDay());
			tp.setCurrentMinute(acd.getAlarmTimeMinutes());
		}

	}

	public void onToggleButtonPillClicked(View view) {
		boolean on = ((ToggleButton) view).isChecked();
		if (on) {
			this.contraceptiveType = ContraceptiveType.CONTRACEPTION_PILL;
			this.turnToggleButtonOff(false, true, true);
		}
	}

	public void onToggleButtonPatchClicked(View view) {
		boolean on = ((ToggleButton) view).isChecked();
		if (on) {
			this.contraceptiveType = ContraceptiveType.CONTRACEPTION_PATCH;
			this.turnToggleButtonOff(true, false, true);
		}
	}

	public void onToggleButtonRingClicked(View view) {
		boolean on = ((ToggleButton) view).isChecked();
		if (on) {
			this.contraceptiveType = ContraceptiveType.CONTRACEPTION_RING;
			this.turnToggleButtonOff(true, true, false);
		}
	}

	private void turnToggleButtonOff(boolean pill, boolean patch, boolean ring) {

		ToggleButton tbPill = (ToggleButton) this.findViewById(R.id.toggleButton_Pill);
		ToggleButton tbPatch = (ToggleButton) this.findViewById(R.id.toggleButton_Patch);
		ToggleButton tbRing = (ToggleButton) this.findViewById(R.id.toggleButton_Ring);

		if (pill) {
			tbPill.setChecked(false);
		}
		if (patch) {
			tbPatch.setChecked(false);
		}
		if (ring) {
			tbRing.setChecked(false);
		}
	}

	public void onToggleButtonAlarmClicked(View view) {
		boolean on = ((ToggleButton) view).isChecked();
		if (on) {
			this.setAlarmCalculationData();
		}
	}

	private void setAlarmCalculationData() {
		TimePicker tp = (TimePicker) this.findViewById(R.id.timePicker);
		tp.clearFocus();
		int hours = tp.getCurrentHour();
		int minutes = tp.getCurrentMinute();

		AlarmCalculationData acd = new AlarmCalculationData();
		acd.setAlarmActive(true);
		acd.setAlarmTimeHourOfDay(hours);
		acd.setAlarmTimeMinuteOfDay(minutes);
		acd.setContraceptiveType(this.contraceptiveType);
		acd.setLastUseOfContraceptiveDayOfYear(CalendarWrapper.getTodayAsDayOfYear());
		acd.setLastBreakDayOfYear(CalendarWrapper.getTodayOneWeekAgoAsDayOfYear());

		LoggerWrapper.LogInfo(acd.toString());
	}

	// TODO: Remove Menu?!
	@Override
	public boolean onCreateOptionsMenu(Menu menu) {
		this.getMenuInflater().inflate(R.menu.activity_main, menu);
		return true;
	}
}
